#
# TODO(aghassemi) These commands are just for convenience.
# Remove this file and references to it from README before release.
#

PATH:=$(PATH):$(VEYRON_ROOT)/environment/cout/node/bin
VEYRON_MOUNTTABLE=$(VEYRON_ROOT)/veyron/go/bin/mounttabled
VEYRON_WSPR=$(VEYRON_ROOT)/veyron/go/bin/wsprd
VEYRON_PROXY=$(VEYRON_ROOT)/veyron/go/bin/proxyd
VEYRON_IDENT=$(VEYRON_ROOT)/veyron/go/bin/identity
VEYRON_IDENTITYD=$(VEYRON_ROOT)/veyron/go/bin/identityd
VEYRON_MOUNTTABLE=$(VEYRON_ROOT)/veyron/go/bin/mounttabled
VEYRON_PROXY_PORT=5164
VEYRON_MOUNTTABLE_PORT=5167
VEYRON_PROXY_ADDR=127.0.0.1:$(VEYRON_PROXY_PORT)
VEYRON_WSPR_PORT=5165
VEYRON_IDENTITY_PORT=5163
VEYRON_JS_API=$(VEYRON_ROOT)/veyron/javascript/api
VEYRON_IDENTITY_PATH=/tmp/p2b_identity

# Builds everything
all: browser/libs/vendor/polymer browser/libs/vendor/veyron

browser/libs/vendor/polymer:
	cp -rf $(VEYRON_ROOT)/third_party/javascript/polymer ./browser/libs/vendor/polymer

browser/libs/vendor/veyron:
	(cd $(VEYRON_JS_API) && ./vgrunt build) && \
	mkdir -p ./browser/libs/vendor/veyron && \
	cp -rf $(VEYRON_JS_API)/dist/*.* ./browser/libs/vendor/veyron

clean:
	rm -rf ./browser/libs/vendor/polymer
	rm -rf browser/libs/vendor/veyron

# Deploys Veyron daemons
daemons:
	@if [[ ! -e $(VEYRON_PROXY) ]]; then \
		echo "Veyron proxy could not be found in $(VEYRON_PROXY). Please build and install veyron2 and services first"; \
		exit 1; \
	fi

	$(VEYRON_IDENT) --name=veyron_p2b_identity > $(VEYRON_IDENTITY_PATH)

	export VEYRON_IDENTITY=$(VEYRON_IDENTITY_PATH) ; \
	$(VEYRON_IDENTITYD) --address=:$(VEYRON_IDENTITY_PORT) & \
	$(VEYRON_MOUNTTABLE) --address=:$(VEYRON_MOUNTTABLE_PORT) & \
	export NAMESPACE_ROOT=/localhost:$(VEYRON_MOUNTTABLE_PORT)/mt ; \
	$(VEYRON_PROXY) -address=$(VEYRON_PROXY_ADDR) & \
	$(VEYRON_WSPR) --v=1 -logtostderr=true -vproxy=$(VEYRON_PROXY_ADDR) --port $(VEYRON_WSPR_PORT) & \
	$(VEYRON_STORE) --address=:$(VEYRON_STORE_PORT) --name=global/$(USER)/store &

killdaemons:
	kill `lsof -t -i:$(VEYRON_MOUNTTABLE_PORT)`; \
	kill `lsof -t -i:$(VEYRON_IDENTITY_PORT)`; \
	kill `lsof -t -i:$(VEYRON_WSPR_PORT)`; \
	kill `lsof -t -i:$(VEYRON_PROXY_PORT)`; \
	kill `lsof -t -i:$(VEYRON_STORE_PORT)`

.PHONY: all clean daemons killdaemons browser/libs/vendor/polymer browser/libs/vendor/veyron